CREATE DATABASE GalaBuilding
ON 
     PRIMARY (NAME = GalaBuilding_Data, 
     FILENAME = 'F:\database\GalaBuilding.MDF' , 
     SIZE = 20MB , 
     MAXSIZE = 200MB , 
     FILEGROWTH = 10MB) 
LOG ON (NAME = GalaBuilding_Log , 
     FILENAME = 'F:\database\GalaBuilding.LDB' , 
     SIZE = 10MB, 
     FILEGROWTH = 5MB) 
GO 

USE GalaBuilding

------------Loại Người dùng --------------------
CREATE TABLE LOAINGUOIDUNG
(
	MaLoaiND	VARCHAR (6)		NOT NULL	PRIMARY KEY,
	TenLoaiND	NVARCHAR(30)	NOT NULL
)

INSERT INTO LOAINGUOIDUNG VALUES('LND001','Giam Doc')
INSERT INTO LOAINGUOIDUNG VALUES('LND002','Pho Giam Doc')
INSERT INTO LOAINGUOIDUNG VALUES('LND003','Quan Doc')

---------------------Người dùng---------------------
CREATE TABLE  NGUOIDUNG
(
	MaND 		VARCHAR (6) 	NOT NULL	PRIMARY KEY,
	MaLoaiND	VARCHAR (6)		NOT NULL,
	TenND		NVARCHAR (30)	NOT NULL,
	TenDangNhap	VARCHAR (20)	NOT NULL,
	MatKhau		VARCHAR (30)	NOT NULL,
	
	CONSTRAINT F_ND_LND FOREIGN KEY(MaLoaiND) 	REFERENCES LOAINGUOIDUNG(MaLoaiND)
)

INSERT INTO NGUOIDUNG VALUES('ND0001','LND001','Admin',		'admin',	'admin')
INSERT INTO NGUOIDUNG VALUES('ND0002','LND002','User',		'user',		'user')
INSERT INTO NGUOIDUNG VALUES('ND0003','LND003','User1',		'user1',	'user1')


---------------------Bảng Lưu Tài Khoản---------------------
CREATE TABLE  LUUTAIKHOAN
(
	TenDangNhap	VARCHAR (20)	NOT NULL,
	MatKhau		VARCHAR (30)	NOT NULL,
)


-----------------Người dân---------------------------
CREATE TABLE NGUOIDAN
(
	MaNguoiDan		VARCHAR (6)		NOT NULL	PRIMARY KEY,
	TenNguoiDan		NVARCHAR(30),
	GioiTinh		BIT,
	NgaySinh		DATETIME
)

INSERT INTO NGUOIDAN VALUES ('ND0001',N'Nguyễn Khánh Dương',	0,'01/02/1996')
INSERT INTO NGUOIDAN VALUES ('ND0002',N'Nguyễn Duy Lâm',		0,'12/03/1996')
INSERT INTO NGUOIDAN VALUES ('ND0003',N'Đặng Văn Duy',		0,'02/03/1996')
INSERT INTO NGUOIDAN VALUES ('ND0004',N'Phạm Nguyễn Tiến',		1,'07/04/1996')
INSERT INTO NGUOIDAN VALUES ('ND0005',N'Trần Quang Khải',	1,'12/08/1996')
INSERT INTO NGUOIDAN VALUES ('ND0006',N'Lại Thị Thanh Trang',		0,'04/05/1996')
INSERT INTO NGUOIDAN VALUES ('ND0007',N'Nguyễn Huy Hiếu',		0,'05/06/1996')
INSERT INTO NGUOIDAN VALUES ('ND0008',N'Trần Huy Hiệu',		0,'07/07/1996')
INSERT INTO NGUOIDAN VALUES ('ND0009',N'Đỗ Bá Tài',		0,'01/09/1996')

INSERT INTO NGUOIDAN VALUES ('ND0010',N'Lê Quang Hải',		0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0011',N'Bùi Minh Tuấn',		0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0012',N'Phan Tấn Đạt',		0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0013',N'Đặng Thanh Cang',	0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0014',N'Nguyễn Anh Đức',	0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0015',N'Nguyễn Tâm Hậu',	0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0016',N'Hoàng Văn Hiếu',	0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0017',N'Trần Thế Hoàn',		0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0018',N'Nguyễn Quang Huy',	0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0019',N'Nguyễn Hữu Minh',	0,'10/10/1996')
INSERT INTO NGUOIDAN VALUES ('ND0020',N'Vương Trần Nguyên',	0,'10/10/1996')

-----------------Căn hộ---------------------------
CREATE TABLE CANHO
(
	MaCanHo			VARCHAR (6)		NOT NULL	PRIMARY KEY,
	TangLau			INT,
	SoNguoi			INT				DEFAULT 0,
	TongPhiDichVu	INT				DEFAULT 0,	
)

INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0101',1)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0102',1)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0103',1)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0104',1)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0105',1)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0106',1)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0107',1)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0108',1)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0109',1)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0110',1)

INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0201',2)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0202',2)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0203',2)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0204',2)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0205',2)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0206',2)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0207',2)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0208',2)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0209',2)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0210',2)

INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0301',3)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0302',3)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0303',3)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0304',3)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0305',3)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0306',3)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0307',3)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0308',3)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0309',3)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0310',3)

INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0401',4)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0402',4)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0403',4)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0404',4)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0405',4)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0406',4)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0407',4)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0408',4)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0409',4)
INSERT INTO CANHO	(MaCanHo, TangLau)
VALUES				('CH0410',4)


-----------------Căn hộ - Người dân---------------------------
CREATE TABLE CANHO_NGUOIDAN
(
	MaNguoiDan		VARCHAR (6)		NOT NULL,
	MaCanHo			VARCHAR (6)		NOT NULL,
	
	CONSTRAINT PK_CANHO_NGUOIDAN	PRIMARY KEY(MaNguoiDan ,	MaCanHo),
	CONSTRAINT FK_MaNguoiDan		FOREIGN KEY(MaNguoiDan)		REFERENCES NGUOIDAN(MaNguoiDan) ON UPDATE CASCADE ON DELETE CASCADE,
	CONSTRAINT FK_MaCanHo			FOREIGN KEY(MaCanHo)		REFERENCES CANHO(MaCanHo)
)
GO


CREATE TRIGGER tg_CANHO_NGUOIDAN_insert ON CANHO_NGUOIDAN
FOR INSERT
AS
	DECLARE @MaCanHo VARCHAR(6)
	SELECT @MaCanHo=MaCanHo FROM INSERTED

	UPDATE CANHO
	SET SoNguoi=SoNguoi+1
	WHERE MaCanHo=@MaCanHo
GO

--DROP TRIGGER tg_CANHO_NGUOIDAN_delete 

CREATE TRIGGER tg_CANHO_NGUOIDAN_delete ON CANHO_NGUOIDAN
FOR DELETE
AS
	DECLARE @MaCanHo VARCHAR(6), @dem INT
	DECLARE @MaNguoiDan VARCHAR(6)

	SELECT @MaCanHo=MaCanHo FROM DELETED
	SELECT @dem=(SELECT COUNT(*) FROM DELETED WHERE MaCanHo=@MaCanHo)
	SELECT @MaNguoiDan=MaNguoiDan FROM DELETED

	UPDATE CANHO
	SET SoNguoi=SoNguoi-@dem
	WHERE MaCanHo=@MaCanHo

	--DELETE FROM NGUOIDAN
	--WHERE MaNguoiDan=@MaNguoiDan
GO



INSERT INTO CANHO_NGUOIDAN VALUES ('ND0001','CH0101')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0002','CH0101')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0003','CH0102')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0004','CH0102')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0005','CH0103')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0006','CH0103')

INSERT INTO CANHO_NGUOIDAN VALUES ('ND0007','CH0104')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0008','CH0104')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0009','CH0105')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0010','CH0105')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0011','CH0106')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0012','CH0106')

INSERT INTO CANHO_NGUOIDAN VALUES ('ND0013','CH0107')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0014','CH0107')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0015','CH0108')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0016','CH0108')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0017','CH0109')
INSERT INTO CANHO_NGUOIDAN VALUES ('ND0018','CH0109')




-----------------Dịch vụ---------------------------
CREATE TABLE DICHVU
(
	MaDichVu	VARCHAR (6)		NOT NULL	PRIMARY KEY,
	TenDichVu 	NVARCHAR (10)	NOT NULL,
	DonGia		INT				NOT NULL,
)

INSERT INTO DICHVU VALUES('DV0001',N'Gửi xe'	,20000)
INSERT INTO DICHVU VALUES('DV0002',N'Đổ rác'	,25000)
INSERT INTO DICHVU VALUES('DV0003',N'Dọn dẹp'	,25000)
INSERT INTO DICHVU VALUES('DV0004',N'An ninh'	,30000)
INSERT INTO DICHVU VALUES('DV0005',N'Hồ bơi'	,35000)
INSERT INTO DICHVU VALUES('DV0006',N'Y tế'		,23000)



-----------------Căn hộ - Dịch vụ---------------------------
CREATE TABLE CANHO_DICHVU
(
	MaCanHo			VARCHAR (6)		NOT NULL,
	MaDichVu		VARCHAR (6)		NOT NULL,
	
	CONSTRAINT PK_CANHO_DICHVU	PRIMARY KEY(MaCanHo, MaDichVu),
	CONSTRAINT FK_MaDichVu2		FOREIGN KEY(MaDichVu)	REFERENCES DICHVU(MaDichVu),
	CONSTRAINT FK_MaCanHo2		FOREIGN KEY(MaCanHo)	REFERENCES CANHO(MaCanHo)
)

GO

CREATE TRIGGER tgCANHO_DICHVU_insert ON CANHO_DICHVU
FOR INSERT
AS
	DECLARE @MaCanHo VARCHAR(6)
	DECLARE @MaDichVu VARCHAR(6)
	DECLARE @DonGia INT

	SELECT @MaCanHo = MaCanHo FROM INSERTED
	SELECT @MaDichVu = MaDichVu FROM INSERTED
	SELECT @DonGia = DonGia FROM INSERTED INNER JOIN DICHVU ON INSERTED.MaDichVu=DICHVU.MaDichVu

	UPDATE CANHO
	SET TongPhiDichVu=TongPhiDichVu + @DonGia
	WHERE MaCanHo=@MaCanHo
GO

--DROP TRIGGER tg_CANHO_DICHVU_delete

CREATE TRIGGER tg_CANHO_DICHVU_delete ON CANHO_DICHVU
FOR DELETE
AS
	DECLARE @MaCanHo VARCHAR(6)
	DECLARE @MaDichVu VARCHAR(6)
	DECLARE @DonGia INT

	SELECT @MaCanHo=MaCanHo FROM DELETED
	SELECT @MaDichVu=MaDichVu FROM DELETED
	SELECT @DonGia = DonGia FROM DELETED INNER JOIN DICHVU ON DELETED.MaDichVu=DICHVU.MaDichVu
	
	UPDATE CANHO
	SET TongPhiDichVu=TongPhiDichVu - @DonGia
	WHERE MaCanHo=@MaCanHo

GO


INSERT INTO CANHO_DICHVU	(MaCanHo, MaDichVu)
VALUES						('CH0101','DV0001')

INSERT INTO CANHO_DICHVU	(MaCanHo, MaDichVu)
VALUES						('CH0102','DV0002')

INSERT INTO CANHO_DICHVU	(MaCanHo, MaDichVu)
VALUES						('CH0103','DV0003')

INSERT INTO CANHO_DICHVU	(MaCanHo, MaDichVu)
VALUES						('CH0104','DV0004')

INSERT INTO CANHO_DICHVU	(MaCanHo, MaDichVu)
VALUES						('CH0105','DV0005')

INSERT INTO CANHO_DICHVU	(MaCanHo, MaDichVu)
VALUES						('CH0106','DV0006')


-----------------Chức vụ---------------------------
CREATE TABLE CHUCVU
(
	MaChucVu	VARCHAR(6)	PRIMARY KEY,
	TenChucVu	NVARCHAR(30)
)

INSERT INTO CHUCVU VALUES ('CV0001',N'NV Thu Phí')
INSERT INTO CHUCVU VALUES ('CV0002',N'NV An Ninh')
INSERT INTO CHUCVU VALUES ('CV0003',N'NV Đổ Rác')
INSERT INTO CHUCVU VALUES ('CV0004',N'NV Bảo Vệ')
INSERT INTO CHUCVU VALUES ('CV0005',N'NV Tạp Vụ')
INSERT INTO CHUCVU VALUES ('CV0006',N'NV Tưới Cây')

-----------------Nhân viên---------------------------
CREATE TABLE NHANVIEN
(
	MaNhanVien	VARCHAR(6) PRIMARY KEY,
	TenNhanVien	NVARCHAR(30),
	GioiTinh	BIT,
	NgaySinh	DATETIME,
	MaChucVu	VARCHAR(6),

	CONSTRAINT FK_MaChucVu FOREIGN KEY (MaChucVu) REFERENCES CHUCVU(MaChucVu)
)

INSERT INTO NHANVIEN VALUES('NV0001',N'Nguyễn Viết Trọng'	,0,'12/12/1984','CV0001')
INSERT INTO NHANVIEN VALUES('NV0002',N'Nguyễn Thị Thảnh'	,0,'08/14/1990','CV0002')
INSERT INTO NHANVIEN VALUES('NV0003',N'Phùng Quang Huy'	,1,'11/12/1975','CV0003')
INSERT INTO NHANVIEN VALUES('NV0004',N'Google'		,0,'12/20/1978','CV0004')
INSERT INTO NHANVIEN VALUES('NV0005',N'Microsoft'		,1,'01/19/1981','CV0005')
INSERT INTO NHANVIEN VALUES('NV0006',N'Talktv'	,0,'07/28/1991','CV0006')

